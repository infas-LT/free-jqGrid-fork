!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./jquery.fmatter","./grid.common"],t):"object"==typeof module&&module.exports?module.exports=function(e,l){return e=e||window,void 0===l&&(l="undefined"!=typeof window?require("jquery"):require("jquery")(e)),require("./grid.base"),require("./jquery.fmatter"),require("./grid.common"),t(l),l}:t(jQuery)}(function(k){"use strict";function E(){var e=k.makeArray(arguments);return e.unshift(""),e.unshift(""),e.unshift(this.p),R.feedback.apply(this,e)}function I(e,l){var t=this.grid.fbRows;return null!=(e=null!=t&&t[0].cells.length>l?t[e.rowIndex]:e)&&null!=e.cells?k(e.cells[l]):k()}var R=k.jgrid;R.extend({editCell:function(j,b,w){return this.each(function(){var e,l,t,i=this,r=k(i),a=i.p,d=i.rows;if(i.grid&&!0===a.cellEdit&&null!=d&&null!=d[j]&&(j=parseInt(j,10),b=parseInt(b,10),!isNaN(j))&&!isNaN(b)){var n=d[j],o=null!=n?n.id:null,s=k(n),c=parseInt(a.iCol,10),u=parseInt(a.iRow,10),d=k(d[u]),f=a.savedRow;if(null!=o){if(a.selrow=o,a.knv||r.jqGrid("GridNav"),0<f.length&&0<d.length){if(!0===w&&j===u&&b===c)return;r.jqGrid("saveCell",f[0].id,f[0].ic)}else setTimeout(function(){k("#"+R.jqID(a.knv)).attr("tabindex","-1").focus()},1);if("subgrid"!==(e=(t=a.colModel[b]).name)&&"cb"!==e&&"rn"!==e){var h=I.call(i,n,b),p=t.editable,g="cell",m=(k.jgrid.isFunction(p)&&(p=p.call(i,{rowid:o,iCol:b,iRow:j,cmName:e,cm:t,mode:g})),r.jqGrid("getGuiStyles","states.select","edit-cell")),C=r.jqGrid("getGuiStyles","states.hover","selected-row");if(!0!==p||!0!==w||h.hasClass("not-editable-cell"))a.noCellSelection||(0<=c&&0<=u&&(I.call(i,d[0],c).removeClass(m),d.removeClass(C)),h.addClass(m),s.addClass(C)),l=h.html().replace(/&#160;/gi,""),E.call(i,"onSelectCell",o,e,l,j,b);else{a.noCellSelection||(0<=c&&0<=u&&(I.call(i,d[0],c).removeClass(m),d.removeClass(C)),h.addClass(m),s.addClass(C)),t.edittype||(t.edittype="text"),u=t.edittype;try{l=k.unformat.call(i,h,{rowId:o,colModel:t},b)}catch(e){l="textarea"===u?h.text():h.html()}("&nbsp;"===(l=a.autoEncodeOnEdit?R.oldDecodePostedData(l):l)||"&#160;"===l||1===l.length&&160===l.charCodeAt(0))&&(l=""),k.jgrid.isFunction(a.formatCell)&&void 0!==(c=a.formatCell.call(i,o,e,l,j,b))&&(l=c),E.call(i,"beforeEditCell",o,e,l,j,b),f.push({id:j,ic:b,name:e,v:l}),a.editingInfo[o]={mode:"cellEditing",savedRow:f[f.length-1],editable:{}},a.editingInfo[o].editable[e]=p;var d=k.extend({},t.editoptions||{},{id:j+"_"+e,name:e,rowId:o,mode:g,cm:t,iCol:b}),v=R.createEl.call(i,u,d,l,!0,k.extend({},R.ajaxOptions,a.ajaxSelectOptions||{})),m=h,s=!0===a.treeGrid&&e===a.ExpandColumn;(m=s?h.children("span.cell-wrapperleaf,span.cell-wrapper"):m).html("").append(v).attr("tabindex","0"),s&&k(v).width(h.width()-h.children("div.tree-wrap").outerWidth()),R.bindEv.call(i,v,d),a.frozenColumns&&b<r.jqGrid("getNumberOfFrozenColumns")&&(C=k(i.rows[n.rowIndex].cells[b]),c=h.height(),f=C.height(),1<=Math.abs(f-c))&&0<c&&(C.height(c),f=C.height(),1<=Math.abs(c-f))&&C.height(c+Math.round(c-f)),setTimeout(function(){k(v).focus()},0),k("input, select, textarea",h).on("keydown",function(e){if(27===e.keyCode&&(!(0<k("input.hasDatepicker",h).length)||k(".ui-datepicker").is(":hidden")?r.jqGrid("restoreCell",j,b):k("input.hasDatepicker",h).datepicker("hide")),13===e.keyCode&&!e.shiftKey)return r.jqGrid("saveCell",j,b),!1;if(9===e.keyCode){if(i.grid.hDiv.loading)return!1;e.shiftKey?r.jqGrid("prevCell",j,b):r.jqGrid("nextCell",j,b)}e.stopPropagation()}),E.call(i,"afterEditCell",o,e,l,j,b)}a.iCol=b,a.iRow=j}}}})},saveCell:function(y,x){return this.each(function(){var i=this,r=k(i),a=i.p,t=i.grid,d=R.info_dialog,e=R.jqID;if(t&&!0===a.cellEdit){var l=r.jqGrid("getGridRes","errors"),n=l.errcap,o=r.jqGrid("getGridRes","edit").bClose,s=a.savedRow,c=1<=s.length?0:null;if(null!==c){var u=i.rows[y],f=null!=u?u.id:null,h=null!=u?k(u):k(),p=a.colModel[x],g=p.name,m=I.call(i,u,x),C={},v=R.getEditedValue.call(i,m,p,C);if(v!==s[c].v){void 0!==(b=r.triggerHandler("jqGridBeforeSaveCell",[f,g,v,y,x]))&&(v=b),k.jgrid.isFunction(a.beforeSaveCell)&&void 0!==(b=a.beforeSaveCell.call(i,f,g,v,y,x))&&(v=b);var j=R.checkValues.call(i,v,x,void 0,void 0,{oldValue:s[c].v,newValue:v,cmName:g,rowid:f,iCol:x,iRow:y,cm:p,tr:u,td:m,mode:"cell"}),b=p.formatoptions||{};if(null==j||!0===j||!0===j[0]){c=r.triggerHandler("jqGridBeforeSubmitCell",[f,g,v,y,x])||{};if(k.jgrid.isFunction(a.beforeSubmitCell)&&(c=(c=a.beforeSubmitCell.call(i,f,g,v,y,x))||{}),0<k("input.hasDatepicker",m).length&&k("input.hasDatepicker",m).datepicker("hide"),"date"===p.formatter&&!0!==b.sendFormatted&&(v=k.unformat.date.call(i,v,p)),"remote"===a.cellsubmit)if(a.cellurl){var w={},b=(w[g]=v,a.prmNames),q=b.id,G=b.oper;w[q]=R.stripPref(a.idPrefix,f),w[G]=b.editoper,w=k.extend(c,w),a.autoEncodeOnEdit&&k.each(w,function(e,l){k.jgrid.isFunction(l)||(w[e]=R.oldEncodePostedData(l))}),r.jqGrid("progressBar",{method:"show",loadtype:a.loadui,htmlcontent:r.jqGrid("getGridRes","defaults.savetext")||"Saving..."}),t.hDiv.loading=!0,k.ajax(k.extend({url:k.jgrid.isFunction(a.cellurl)?a.cellurl.call(i,a.cellurl,y,x,f,v,g):a.cellurl,data:R.serializeFeedback.call(i,a.serializeCellData,"jqGridSerializeCellData",w),type:"POST",complete:function(e){var l;t.endReq.call(i),!(e.status<300||304===e.status)||0===e.status&&4===e.readyState||(null==(l=!0===(l=r.triggerHandler("jqGridAfterSubmitCell",[i,e,w.id,g,v,y,x])||[!0,""])||!0===l[0]&&k.jgrid.isFunction(a.afterSubmitCell)?a.afterSubmitCell.call(i,e,w.id,g,v,y,x):l)||!0===l||!0===l[0]?(r.jqGrid("setCell",f,x,v,!1,!1,!0),m.addClass("dirty-cell"),h.addClass("edited"),E.call(i,"afterSaveCell",f,g,v,y,x),s.splice(0,1),delete a.editingInfo[f]):(d.call(i,n,l[1],o),r.jqGrid("restoreCell",y,x)))},error:function(e,l,t){r.triggerHandler("jqGridErrorCell",[e,l,t]),k.jgrid.isFunction(a.errorCell)?a.errorCell.call(i,e,l,t):d.call(i,n,e.status+" : "+e.statusText+"<br/>"+l,o),r.jqGrid("restoreCell",y,x)}},R.ajaxOptions,a.ajaxCellOptions||{}))}else try{d.call(i,n,l.nourl,o),r.jqGrid("restoreCell",y,x)}catch(e){}if("clientArray"===a.cellsubmit){if(r.jqGrid("setCell",f,x,"select"===p.edittype&&"select"!==p.formatter?C.text:v,!1,!1,!0),m.addClass("dirty-cell"),h.addClass("edited"),E.call(i,"afterSaveCell",f,g,v,y,x),a.frozenColumns&&x<r.jqGrid("getNumberOfFrozenColumns"))try{i.rows[u.rowIndex].cells[x].style.height=""}catch(e){}s.splice(0,1),delete a.editingInfo[f]}}else try{setTimeout(function(){var e=R.getRelativeRect.call(i,m);d.call(i,n,v+" "+j[1],o,{top:e.top,left:e.left+k(i).closest(".ui-jqgrid").offset().left})},50),r.jqGrid("restoreCell",y,x)}catch(e){}}else r.jqGrid("restoreCell",y,x)}setTimeout(function(){k("#"+e(a.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(o,s){return this.each(function(){var e,l,t=this,i=t.p,r=t.rows[o],a=r.id;if(t.grid&&!0===i.cellEdit){var d=i.savedRow,n=I.call(t,r,s);if(1<=d.length){if(k.jgrid.isFunction(k.fn.datepicker))try{k("input.hasDatepicker",n).datepicker("hide")}catch(e){}if(e=i.colModel[s],(!0===i.treeGrid&&null!=e&&e.name===i.ExpandColumn?n.children("span.cell-wrapperleaf,span.cell-wrapper"):n).empty(),n.attr("tabindex","-1"),n=d[0].v,null!=e&&(l=e.formatoptions||{},"date"===e.formatter&&!0!==l.sendFormatted&&(n=k.unformat.date.call(t,n,e)),k(t).jqGrid("setCell",a,s,n,!1,!1,!0),i.frozenColumns)&&s<k(t).jqGrid("getNumberOfFrozenColumns"))try{t.rows[r.rowIndex].cells[s].style.height=""}catch(e){}E.call(t,"afterRestoreCell",a,n,o,s),d.splice(0,1),delete i.editingInfo[a]}setTimeout(function(){k("#"+i.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(o,s){return this.each(function(){var e,l,t,i=this,r=k(i),a=i.p,d=!1,n=i.rows;if(i.grid&&!0===a.cellEdit&&null!=n&&null!=n[o]){for(e=s+1;e<a.colModel.length;e++)if(l=(t=a.colModel[e]).editable,!0===(l=k.jgrid.isFunction(l)?l.call(i,{rowid:n[o].id,iCol:e,iRow:o,cmName:t.name,cm:t,mode:"cell"}):l)){d=e;break}!1!==d?r.jqGrid("editCell",o,d,!0):0<a.savedRow.length&&r.jqGrid("saveCell",o,s)}})},prevCell:function(o,s){return this.each(function(){var e,l,t,i=this,r=k(i),a=i.p,d=!1,n=i.rows;if(i.grid&&!0===a.cellEdit&&null!=n&&null!=n[o]){for(e=s-1;0<=e;e--)if(l=(t=a.colModel[e]).editable,!0===(l=k.jgrid.isFunction(l)?l.call(i,{rowid:n[o].id,iCol:e,iRow:o,cmName:t.name,cm:t,mode:"cell"}):l)){d=e;break}!1!==d?r.jqGrid("editCell",o,d,!0):0<a.savedRow.length&&r.jqGrid("saveCell",o,s)}})},GridNav:function(){return this.each(function(){var i,r,n,e,o=this,a=k(o),d=o.p,l=o.grid;function s(e,l,t){var i,r,a,d,e=o.rows[e];"v"===t.substr(0,1)&&(i=n.clientHeight,d=n.scrollTop,r=e.offsetTop+e.clientHeight,a=e.offsetTop,"vd"===t&&d+i<=r&&(n.scrollTop=n.scrollTop+e.clientHeight),"vu"===t)&&a<d&&(n.scrollTop=n.scrollTop-e.clientHeight),"h"===t&&(i=n.clientWidth,r=n.scrollLeft,d=(a=e.cells[l]).offsetLeft+a.clientWidth,t=a.offsetLeft,d>=i+parseInt(r,10)?n.scrollLeft=n.scrollLeft+a.clientWidth:t<r&&(n.scrollLeft=n.scrollLeft-a.clientWidth))}function c(e,l){var t,i=0,r=d.colModel;if("lft"===l)for(i=e+1,t=e;0<=t;t--)if(!0!==r[t].hidden){i=t;break}if("rgt"===l)for(i=e-1,t=e;t<r.length;t++)if(!0!==r[t].hidden){i=t;break}return i}l&&!0===d.cellEdit&&(n=l.bDiv,d.knv=d.id+"_kn",e=k("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+d.knv+"'></div></div>"),k(e).insertBefore(l.cDiv),k("#"+d.knv).focus().keydown(function(e){var l=parseInt(d.iRow,10),t=parseInt(d.iCol,10);switch(r=e.keyCode,"rtl"===d.direction&&(37===r?r=39:39===r&&(r=37)),r){case 38:0<l-1&&(s(l-1,t,"vu"),a.jqGrid("editCell",l-1,t,!1));break;case 40:l+1<=o.rows.length-1&&(s(l+1,t,"vd"),a.jqGrid("editCell",l+1,t,!1));break;case 37:0<=t-1&&(s(l,i=c(t-1,"lft"),"h"),a.jqGrid("editCell",l,i,!1));break;case 39:t+1<=d.colModel.length-1&&(s(l,i=c(t+1,"rgt"),"h"),a.jqGrid("editCell",l,i,!1));break;case 13:0<=t&&0<=l&&a.jqGrid("editCell",l,t,!0);break;default:return!0}return!1}))})},getChangedCells:function(u){var e=[];return u=u||"all",this.each(function(){var n=this,o=n.p,s=R.htmlDecode,c=n.rows;n.grid&&!0===o.cellEdit&&k(c).each(function(r){var a,d={};k(this).hasClass("edited")&&(k((a=this).cells).each(function(e){var l=o.colModel[e],t=l.name,i=I.call(n,a,e);if("cb"!==t&&"subgrid"!==t&&"rn"!==t&&("dirty"!==u||i.hasClass("dirty-cell")))try{d[t]=k.unformat.call(n,i[0],{rowId:c[r].id,colModel:l},e)}catch(e){d[t]=s(i.html())}}),d.id=this.id,e.push(d))})}),e}})});
//# sourceMappingURL=grid.celledit.js.map