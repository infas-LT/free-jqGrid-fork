!function(r){"use strict";"function"==typeof define&&define.amd?define(["jquery","./jquery.fmatter","./grid.grouping"],r):"object"==typeof module&&module.exports?module.exports=function(e,t){return e=e||window,void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(e)),require("./jquery.fmatter"),require("./grid.grouping"),r(t),t}:r(jQuery)}(function(me){"use strict";var ye=me.jgrid;function he(e,t,r){if(!(this instanceof he))return new he(e);this.aggregator=e,this.finilized=!1,this.context=t,this.pivotOptions=r}function xe(e,t,r,o,i){function n(e,t){var r=e,o=t;if(null==r&&(r=""),null==o&&(o=""),r=String(r),o=String(o),this.caseSensitive||(r=r.toUpperCase(),o=o.toUpperCase()),r===o){if(e===t)return 0;if(void 0===e)return-1;if(void 0===t)return 1;if(null===e)return-1;if(null===t)return 1}return r<o?-1:1}function a(e,t){return(e=Number(e))===(t=Number(t))?0:e<t?-1:1}function s(e,t){return(e=Math.floor(Number(e)))===(t=Math.floor(Number(t)))?0:e<t?-1:1}var u,l,g=o.length,f=this;for(f.items=[],f.indexesOfSourceData=[],f.trimByCollect=e,f.caseSensitive=t,f.skipSort=r,f.fieldLength=g,f.fieldNames=new Array(g),f.fieldSortDirection=new Array(g),f.fieldCompare=new Array(g),u=0;u<g;u++){switch(l=o[u],f.fieldNames[u]=l[i||"dataName"],l.sorttype){case"integer":case"int":f.fieldCompare[u]=s;break;case"number":case"currency":case"float":f.fieldCompare[u]=a;break;default:f.fieldCompare[u]=me.jgrid.isFunction(l.compare)?l.compare:n}f.fieldSortDirection[u]="desc"===l.sortorder?-1:1}}he.prototype.calc=function(e,t,r,o,i){var n=this;if(void 0!==e)switch(n.result=n.result||0,e=parseFloat(e),n.aggregator){case"sum":n.result+=e;break;case"count":n.result++;break;case"avg":n.finilized?(n.count=n.count||0,n.result=(n.result*n.count+e)/(n.count+1)):(n.result+=e,n.count=n.count||0),n.count++;break;case"min":n.result=Math.min(n.result,e);break;case"max":n.result=Math.max(n.result,e);break;default:me.jgrid.isFunction(n.aggregator)&&(n.result=n.aggregator.call(n.context,{previousResult:n.result,value:e,fieldName:t,item:r,iItem:o,items:i}))}},he.prototype.getResult=function(e,t,r){var o=this;void 0===o.result&&!r||(r&&void 0!==o.result&&(o.result=0,o.count=0),void 0===o.result||o.finilized||"avg"!==o.aggregator||(o.result=o.result/o.count,o.finilized=!0),e[t]=o.result)},xe.prototype.compareVectorsEx=function(e,t){for(var r,o=this.fieldLength,i=0;i<o;i++)if(0!==(r=this.fieldCompare[i](e[i],t[i])))return{index:i,result:r};return{index:-1,result:0}},xe.prototype.getIndexOfDifferences=function(e,t){return null===t||null===e?0:this.compareVectorsEx(e,t).index},xe.prototype.compareVectors=function(e,t){e=this.compareVectorsEx(e,t);return 0<(0<=e.index?this.fieldSortDirection[e.index]:1)?e.result:-e.result},xe.prototype.getItem=function(e){return this.items[e]},xe.prototype.getIndexLength=function(){return this.items.length},xe.prototype.getIndexesOfSourceData=function(e){return this.indexesOfSourceData[e]},xe.prototype.createDataIndex=function(e){for(var t,r,o,i,n,a,s,u,l=this,g=e.length,f=l.fieldLength,p=l.fieldNames,c=l.indexesOfSourceData,d=l.items,m=0;m<g;m++){for(a=e[m],t=new Array(f),o=0;o<f;o++)void 0!==(r=a[p[o]])&&("string"==typeof r&&l.trimByCollect&&(r=me.jgrid.trim(r)),t[o]=r);if((u=d.length-1)<(s=0))d.push(t),c.push([m]);else if(0===(i=l.compareVectors(t,d[u])))c[u].push(m);else if(1===i||l.skipSort)d.push(t),c.push([m]);else if(1===(i=l.compareVectors(d[0],t)))d.unshift(t),c.unshift([m]);else if(0===i)c[0].push(m);else for(;;){if(u-s<2){d.splice(u,0,t),c.splice(u,0,[m]);break}if(n=Math.floor((s+u)/2),0===(i=l.compareVectors(d[n],t))){c[n].push(m);break}1===i?u=n:s=n}}},ye.extend({pivotSetup:function(o,t){function Y(e,t,r){return t=new xe(I.trimByCollect,I.caseSensitive,t,e),me.jgrid.isFunction(r)&&(t.compareVectorsEx=r),t.createDataIndex(o),t}function e(e,t,r){for(var o,i=0;i<D;i++)void 0===(o=C[i]).template&&void 0===o.formatter&&I.defaultFormatting&&(o.template="count"===o.aggregator?"integer":"number"),oe.push(se(e,o,i,t,r))}function B(e,t,r){for(var o,i,n,a=A-1;t<=a;a--)if(k[a]){for(o=0;o<=a;o++)(Q=T[o].groupHeaders)[Q.length-1].numberOfColumns+=D;for(i=(s=O[a]).totalHeader,n=s.headerOnTop,o=a+1;o<=A-1;o++)T[o].groupHeaders.push({titleText:n&&o===a+1||!n&&o===A-1?me.jgrid.isFunction(i)?i.call(S,r,a):ye.template.call(S,String(i||""),r[a],a):"",startColumnName:"y"+(e-1)+"t"+a+(1===D?"":"a0"),numberOfColumns:D})}}function q(e,t,r,o){var i,n,a,s=w.getIndexOfDifferences(t,r);if(null!==r)for(s=Math.max(s,0),i=A-1;s<=i;i--)n="y"+e+"t"+i+(1<D?"a"+o:""),k[i]&&void 0===x[n]&&((a=F[i][o]).getResult(x,n),x.pivotInfos[n]={colType:1,iA:o,a:C[o],level:i,iRows:a.groupInfo.iRows,rows:a.groupInfo.rows,ys:a.groupInfo.ys,iYs:a.groupInfo.iYs},t!==r)&&(F[i][o]=ue(o))}var r,i,n,P,a,s,u,l,g,f,L,z,M,p,X,c,E,G,d,m,U,y,h,x,v,Q,J,K,w,b,S=this[0],W=Array.isArray,Z={},$={groupField:[],groupSummary:[],groupSummaryPos:[]},_={grouping:!0,groupingView:$},I=me.extend({totals:!1,useColSpanStyle:!1,trimByCollect:!0,skipSortByX:!1,skipSortByY:!1,caseSensitive:!1,footerTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,defaultFormatting:!0,data:o},t||{}),ee=(o.length,I.xDimension),O=I.yDimension,C=I.aggregates,te=I.totalText||I.totals||I.rowTotals||I.totalHeader,j=W(ee)?ee.length:0,re=W(O)?O.length:0,D=W(C)?C.length:0,A=re-(1===D?1:0),T=[],k=[],oe=[],ie=[],ne=["pivotInfos"],ae=new Array(D),F=new Array(re),se=function(e,t,r,o,i){var n,a;switch(e){case 1:n=O[o].totalText||"{0} {1} {2}",a="y"+i+"t"+o;break;case 2:n=I.totalText||"{0}",a="t";break;default:n=1<D?t.label||"{0}":me.jgrid.isFunction(O[o].label)?O[o].label:w.getItem(i)[o],a="y"+i}return delete(e=me.extend({},t,{name:a+(1<D?"a"+r:""),label:me.jgrid.isFunction(n)?n.call(S,2===e?{aggregate:t,iAggregate:r,pivotOptions:I}:1===e?{yIndex:w.getItem(i),aggregate:t,iAggregate:r,yLevel:o,pivotOptions:I}:{yData:w.getItem(i)[o],yIndex:w.getItem(i),yLevel:o,pivotOptions:I}):ye.template.apply(S,2===e?[String(n),t.aggregator,t.member,r]:[String(n),t.aggregator,t.member,w.getItem(i)[o],o])})).member,delete e.aggregator,e},ue=function(e){e=new he("count"===C[e].aggregator?"sum":C[e].aggregator,S,t);return e.groupInfo={iRows:[],rows:[],ys:[],iYs:[]},e};if(0===j||0===D)throw"xDimension or aggregates options are not set!";for(K=Y(ee,I.skipSortByX,I.compareVectorsByX),w=Y(O,I.skipSortByY,I.compareVectorsByY),t.xIndex=K,t.yIndex=w,i=0;i<j;i++)u={name:"x"+i,label:null!=(a=ee[i]).label?me.jgrid.isFunction(a.label)?a.label.call(S,a,i,I):a.label:a.dataName,frozen:I.frozenStaticCols},i<j-1&&!a.skipGrouping&&!a.additionalProperty&&($.groupField.push(u.name),$.groupSummary.push(I.groupSummary),$.groupSummaryPos.push(I.groupSummaryPos)),delete(u=me.extend(u,a)).dataName,delete u.footerText,a.additionalProperty?ne.push(u.name):(oe.push(u),_.sortname=u.name);for(j<2&&(_.grouping=!1),$.hideFirstGroupCol=!0,i=0;i<re;i++)s=O[i],k.push(!!(s.totals||s.rowTotals||s.totalText||s.totalHeader));for(v=w.getItem(0),e(0,re-1,0),b=w.getIndexLength(),d=1;d<b;d++){for(m=w.getItem(d),i=w.getIndexOfDifferences(m,v),n=A-1;i<=n;n--)k[n]&&e(1,n,d-1);v=m,e(0,re-1,d)}for(i=A-1;0<=i;i--)k[i]&&e(1,i,b-1);for(te&&e(2),v=w.getItem(0),n=0;n<A;n++)T.push({useColSpanStyle:I.useColSpanStyle,groupHeaders:[{titleText:me.jgrid.isFunction(O[n].label)?O[n].label.call(S,{yData:v[n],yIndex:v,yLevel:n,pivotOptions:I}):v[n],startColumnName:1===D?"y0":"y0a0",numberOfColumns:D}]});for(d=1;d<b;d++){for(m=w.getItem(d),B(d,i=w.getIndexOfDifferences(m,v),v),n=A-1;i<=n;n--)T[n].groupHeaders.push({titleText:me.jgrid.isFunction(O[n].label)?O[n].label.call(S,{yData:m[n],yIndex:m,yLevel:n,pivotOptions:I}):m[n],startColumnName:"y"+d+(1===D?"":"a0"),numberOfColumns:D});for(n=0;n<i;n++)(Q=T[n].groupHeaders)[Q.length-1].numberOfColumns+=D;v=m}if(B(b,0,v),te)for(i=0;i<A;i++)T[i].groupHeaders.push({titleText:!(i<A-1)&&I.totalHeader||"",startColumnName:"t"+(1===D?"":"a0"),numberOfColumns:D});for(E=K.getIndexLength(),f=0;f<E;f++){for(L=K.getItem(f),x={pivotInfos:z={iX:f,x:L}},i=0;i<j;i++)x["x"+i]=L[i];if(G=K.getIndexesOfSourceData(f),te)for(n=0;n<D;n++)ae[n]=ue(n);v=null,N=R=void 0;for(var N,R=A-1;0<=R;R--)if(k[R])for(null==F[R]&&(F[R]=new Array(D)),N=0;N<D;N++)F[R][N]=ue(N);for(d=0;d<b;d++){for(m=w.getItem(d),U=w.getIndexesOfSourceData(d),n=0;n<D;n++){for(null!==v&&q(d-1,m,v,n),y=[],i=0;i<U.length;i++)J=U[i],0<=me.inArray(J,G)&&y.push(J);if(0<y.length){for(M=new Array(y.length),p=new he((h=C[n]).aggregator,S,t),l=0;l<y.length;l++){r=o[i=y[l]],M[l]=r,p.calc(r[h.member],h.member,r,i,o),te&&((X=ae[n]).calc(r[h.member],h.member,r,i,o),c=X.groupInfo,me.inArray(i,c.iYs)<0&&(c.iYs.push(d),c.ys.push(m)),me.inArray(i,c.iRows)<0)&&(c.iRows.push(i),c.rows.push(r)),V=H=void 0;var H,V,le=m,ge=h,fe=n,pe=r,ce=i,de=d;if(le!==v)for(H=A-1;0<=H;H--)k[H]&&((V=F[H][fe]).calc(pe[ge.member],ge.member,pe,ce,o),V=V.groupInfo,me.inArray(de,V.iYs)<0&&(V.iYs.push(de),V.ys.push(le)),me.inArray(ce,V.iRows)<0)&&(V.iRows.push(ce),V.rows.push(pe))}p.getResult(x,g="y"+d+(1===D?"":"a"+n)),z[g]={colType:0,iY:d,y:m,iA:n,a:h,iRows:y,rows:M}}}v=m}if(null!==v)for(n=0;n<D;n++)q(b-1,v,v,n);if(te)for(n=0;n<D;n++)(X=ae[n]).getResult(x,g="t"+(1===D?"":"a"+n)),c=X.groupInfo,z[g]={colType:2,iA:n,a:C[n],iRows:c.iRows,rows:c.rows,iYs:c.iYs,ys:c.ys};ie.push(x)}if(I.footerTotals||I.colTotals){for(P=ie.length,i=0;i<j;i++)Z["x"+i]=ee[i].footerText||"";for(i=j;i<oe.length;i++){for(g=oe[i].name,p=new he(I.footerAggregator||"sum",S,t),l=0;l<P;l++)x=ie[l],p.calc(x[g],g,x,l,ie);p.getResult(Z,g)}}return t.colHeaders=T,{colModel:oe,additionalProperties:ne,options:t,rows:ie,groupOptions:_,groupHeaders:T,summary:Z}},jqPivot:function(l,g,f,r){return this.each(function(){var a=this,s=me(a),u=me.fn.jqGrid;function t(){var e,t=u.pivotSetup.call(s,l,g),r=t.groupHeaders,o=0<function(e){var t,r=0;for(t in e)e.hasOwnProperty(t)&&r++;return r}(t.summary),i=t.groupOptions.groupingView,n=ye.from.call(a,t.rows);if(!g.skipSortByX)for(e=0;e<i.groupField.length;e++)n.orderBy(i.groupField[e],null!=f&&f.groupingView&&null!=f.groupingView.groupOrder&&"desc"===f.groupingView.groupOrder[e]?"d":"a","text","");if(g.data=l,u.call(s,me.extend(!0,{datastr:me.extend(n.select(),o?{userdata:t.summary}:{}),datatype:"jsonstring",footerrow:o,userDataOnFooter:o,colModel:t.colModel,additionalProperties:t.additionalProperties,pivotOptions:t.options,viewrecords:!0,sortname:g.xDimension[0].dataName},t.groupOptions,f||{})),r.length)for(e=0;e<r.length;e++)r[e]&&r[e].groupHeaders.length&&u.setGroupHeaders.call(s,r[e]);g.frozenStaticCols&&u.setFrozenColumns.call(s)}"string"==typeof l?me.ajax(me.extend({url:l,dataType:"json",success:function(e){l=ye.getAccessor(e,r&&r.reader?r.reader:"rows"),t()}},r||{})):t()})}})});
//# sourceMappingURL=grid.pivot.js.map