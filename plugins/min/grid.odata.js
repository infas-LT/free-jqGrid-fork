/**
 * @license OData plugin for Free-jqGrid
 *
 * Copyright (c) 2014-2018, Mark Babayev (https://github.com/mirik123) markolog@gmail.com
 * License MIT (MIT-LICENSE.txt)
 *
 * inspired by Richard Bennett gist code: jqGrid.ODataExtensions.js
 * https://gist.github.com/dealproc/6678280
 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","free-jqgrid/grid.base"],a):"object"==typeof module&&module.exports?module.exports=function(e,t){return void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(e||window)),require("free-jqgrid/grid.base"),a(t),t}:a(jQuery)}(function(v){"use strict";v.jgrid.odataHelper={resolveJsonReferences:function(e,o){var i,d,l={};for(o=o||[],e=function e(t,a,n){if("object"==typeof t&&t)if("[object Array]"===Object.prototype.toString.call(t))for(i=0;i<t.length;i++){if("object"!=typeof t[i]||!t[i])return t[i];t[i].$ref?t[i]=e(t[i],i,t):t[i]=e(t[i],a,t)}else{if(t.$ref)return d=t.$ref,l[d]||void o.push([n,a,d]);if(t.$id){var r,n=t.$id;if(delete t.$id,t.$values)t=t.$values.map(e);else for(r in t)t.hasOwnProperty(r)&&(t[r]=e(t[r],r,t));l[n]=t}}return t}(e="string"==typeof e?JSON.parse(e):e),i=0;i<o.length;i++)(d=o[i])[0][d[1]]=l[d[2]];return e},convertXmlToJson:function(e){var t,a,n,r,o,i,d={};if(!e)return null;if(1===e.nodeType){if(0<e.attributes.length)for(d["@attributes"]={},a=0;a<e.attributes.length;a++)n=e.attributes.item(a),d["@attributes"][n.nodeName]=n.nodeValue}else 3===e.nodeType?d=e.nodeValue:e.nodeType||(d=e);if(e.hasChildNodes&&e.hasChildNodes())for(t=0;t<e.childNodes.length;t++){if(3===(r=e.childNodes.item(t)).nodeType)return r.nodeValue;void 0===d[o=r.nodeName]?d[o]=v.jgrid.odataHelper.convertXmlToJson(r):(void 0===d[o].push&&(i=d[o],d[o]=[],d[o].push(i)),d[o].push(v.jgrid.odataHelper.convertXmlToJson(r)))}return v.isEmptyObject(d)?null:d},parseMetadata:function(e,t){var a,l,s,c,u,n;switch(t){case"xml":s={},c=[],u={},n=v("Schema",l=e).attr("Namespace")+".",v("EntityContainer EntitySet",l).each(function(e,t){s[v(t).attr("EntityType").replace(n,"")]=v(t).attr("Name"),c.push(v(t).attr("Name"))}),v("EntityType, ComplexType",l).each(function(){var a,n,r,o,i,e=v(this).find("Property,NavigationProperty"),t=v("Key PropertyRef",this),d=t&&0<t.length?t.first().attr("Name"):"",t=v(this).attr("Name");e&&(a=[],e.each(function(e,t){i={},v.each(t.attributes,function(){i[this.name]=this.value}),n=i.Name===d,o="NavigationProperty"===t.tagName,r="Property"===t.tagName&&0<v('ComplexType[Name="'+i.Name+'"]',l).length,a.push(v.extend({iskey:n,isComplex:r,isNavigation:o,isCollection:0<=v.inArray(i.Name,c)},i))}),s[t]&&(u[s[t]]=a),u[t]=a)}),a=u;break;case"json":a=function(e){for(var t,a,n,r,o,i,d,l,s,c,u={},p={},f=[],m=0;m<e.EntityContainer.Elements.length;m++)p[e.EntityContainer.Elements[m].Type.ElementType.Definition.Name]=e.EntityContainer.Elements[m].Name,f.push(e.EntityContainer.Elements[m].Name);for(m=0;m<e.SchemaElements.length;m++)if(a=Array.prototype.concat(e.SchemaElements[m].DeclaredProperties,e.SchemaElements[m].NavigationProperties).filter(function(e){return!!e}),n=(c=e.SchemaElements[m].DeclaredKey)&&0<c.length?c[0].Name:"",c=e.SchemaElements[m].Name,a){for(t=[],o=0;o<a.length;o++)r=a[o].Name===n,l=a[o].Type.IsNullable,s=a[o].Type.Definition.Namespace+a[o].Type.Definition.Name,d=!(i=!!a[o].Type.Definition.DeclaredProperties)&&!a[o].Type,t.push({Name:a[o].Name,Type:s,Nullable:l,iskey:r,isComplex:i,isNavigation:d,isCollection:0<=v.inArray(a[o].Name,f)});p[c]&&(u[p[c]]=t),u[c]=t}return u}(e);break;case"datajs":a=function(e){for(var t,a,n,r,o,i,d,l,s,c,u,p={},f={},m=[],y=[],g=e.dataServices.schema[0],h=g.namespace+".",x=0;x<g.entityContainer[0].entitySet.length;x++)f[g.entityContainer[0].entitySet[x].entityType.replace(h,"")]=g.entityContainer[0].entitySet[x].name,m.push(g.entityContainer[0].entitySet[x].name);for(x=0;x<g.complexType.length;x++)y.push(g.complexType[x].name);for(u=Array.prototype.concat(g.entityType,g.complexType).filter(function(e){return!!e}),x=0;x<u.length;x++)if(a=Array.prototype.concat(u[x].property,u[x].navigationProperty).filter(function(e){return!!e}),n=(c=u[x].key)&&0<c.propertyRef.length?c.propertyRef[0].name:"",c=u[x].name,a){for(t=[],o=0;o<a.length;o++)r=a[o].name===n,l="false"!==a[o].nullable,s=a[o].type,i=!!a[o].type&&0<=v.inArray(a[o].type.replace(h,""),y),d=!a[o].type,t.push({Name:a[o].name,Type:s,Nullable:l,iskey:r,isComplex:i,isNavigation:d,isCollection:0<=v.inArray(a[o].name,m)});f[c]&&(p[f[c]]=t),p[c]=t}return p}(e)}return a},loadError:function(e,t,a){var n=e.status,r=a;if(!e.responseJSON)if(e.responseXML)e.responseText=e.responseText.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>"),e.responseXML=v.parseXML(e.responseText),e.responseJSON=v.jgrid.odataHelper.convertXmlToJson(e.responseXML);else if(e.responseText)try{e.responseJSON=v.parseJSON(e.responseText)}catch(e){}return e.responseJSON?(e=e.responseJSON["@odata.error"]||e.responseJSON["odata.error"]||e.responseJSON.error)&&(r=e.innererror?e.innererror.internalexception?(t=e.innererror.internalexception.message,e.innererror.internalexception.stacktrace||""):(t=e.innererror.message,e.innererror.stacktrace||""):(t=e.message.value||e.message,e.stacktrace||"")):a&&v.isPlainObject(a)&&(t=a.message,r=a.stack,n=a.code),"<div>Status/error code: "+n+"</div><div>Message: "+t+'</div><div style="font-size: 0.8em;">'+r+"</div><br/>"}},v.jgrid.cmTemplate.odataComplexType={editable:!1,formatter:function(e,t,a){return v(this).jqGrid("odataJson",e,t,a)}},v.jgrid.cmTemplate.odataNavigationProperty={editable:!1,formatter:function(e,t,a){return t.colModel.odata.expand&&"link"!==t.colModel.odata.expand?"json"===t.colModel.odata.expand?v(this).jqGrid("odataJson",e,t,a):"subgrid"===t.colModel.odata.expand?v(this).jqGrid("odataSubgrid",e,t,a):void 0:v(this).jqGrid("odataLink",e,t,a)}},v.jgrid.cmTemplate["Edm.GeographyPoint"]={editable:!1,formatter:function(e,t,a){return e||"xml"!==this.p.datatype||(a=v(a).filter(function(){return this.localName.toLowerCase()===t.colModel.name.toLowerCase()}),e=v.jgrid.odataHelper.convertXmlToJson(a[0])),e.crs&&e.coordinates?v.jgrid.format("<div>{0}</div><div>[{1},{2}]</div>",e.crs.properties.name,e.coordinates[0],e.coordinates[1]):v.jgrid.format("<div>{0}</div>",e)}},v.jgrid.extend({odataLink:function(e,t,a){var n,r,o=this[0].p;if("xml"!==o.datatype){if(a[t.colModel.name+"@odata.navigationLink"])return n=a[t.colModel.name+"@odata.navigationLink"],v.jgrid.format('<a href="{0}/{1}" target="_self">{2}</a>',o.odata.baseUrl,n,t.colModel.name);n=a[o.jsonReader.id]}else r=o.xmlReader.id.toLowerCase(),n=v(a).filter(function(){return this.localName&&this.localName.toLowerCase()===r}).text();return o.odata.iscollection?v.jgrid.format('<a href="{0}({1})/{2}" target="_self">{2}</a>',o.url,n,t.colModel.name):v.jgrid.format('<a href="{0}/{1}" target="_self">{1}</a>',o.url,t.colModel.name)},odataJson:function(e,t,a){var n,r={};for(n in"xml"===this[0].p.datatype&&(a=v(a).filter(function(){return this.localName.toLowerCase()===t.colModel.name.toLowerCase()}),e=v.jgrid.odataHelper.convertXmlToJson(a[0])),e)e.hasOwnProperty(n)&&n&&n.indexOf("@odata.")<0&&n.indexOf("@attributes")<0&&(r[n]=e[n]);return JSON.stringify(r,null,1)},odataSubgrid:function(e,t,a){var n,r,o=this[0].p,i="xml"!==o.datatype?a[o.jsonReader.id]:(r=o.xmlReader.id.toLowerCase(),v(a).filter(function(){return this.localName&&this.localName.toLowerCase()===r}).text());for(n in o._index)if(o._index.hasOwnProperty(n)&&n&&i===o._index[n].toString()){i=n;break}return v.jgrid.format('<a style="cursor:pointer" data-id="{0}" onclick=\'$("#{2}").jqGrid("setGridParam", { odata: {activeEntitySet: "{1}" } });$("#{2}").jqGrid("expandSubGridRow", "{0}");return false;\'>{1}</a>',i,t.colModel.name,t.gid)},parseColumns:function(e,t){for(var a,n,r,o,i,d,l,s=0,c=[],s=0;s<e.length;s++)a=0<="Edm.Int16,Edm.Int32,Edm.Int64".indexOf(e[s].Type),n=0<="Edm.Decimal,Edm.Double,Edm.Single".indexOf(e[s].Type),o=0<="Edm.Byte,Edm.SByte".indexOf(e[s].Type),r=e[s].Type&&0<=e[s].Type.indexOf("Edm.")&&(0<=e[s].Type.indexOf("Date")||0<=e[s].Type.indexOf("Time")),i=v.jgrid.cmTemplate[e[s].Type]?e[s].Type:e[s].isComplex?"odataComplexType":e[s].isNavigation?"odataNavigationProperty":a?"integerStr":n?"numberStr":o?"booleanCheckbox":"text",d={integer:a,number:n,date:r,required:!e[s].Nullable||"false"===e[s].Nullable},l=e[s].isNavigation||e[s].isComplex?'<span class="ui-icon ui-icon-arrowreturn-1-s" style="display:inline-block;vertical-align:middle;"></span>'+e[s].Name:e[s].Name,c.push(v.extend({label:l,name:e[s].Name,index:e[s].Name,editable:!e[s].isNavigation&&!e[s].iskey,searchrules:d,editrules:d,searchtype:l=a?"integer":n?"number":r?"datetime":o?"checkbox":"text",inputtype:l,edittype:l,key:e[s].iskey,odata:{expand:e[s].isNavigation?t:e[s].isComplex?"json":null,isnavigation:e[s].isNavigation,iscomplex:e[s].isComplex,iscollection:e[s].isCollection}},v.jgrid.cmTemplate[i]));return c},odataInit:function(o){function i(e,t,a,n){var r,o;if(t&&(a||"nu"===n||"nn"===n)){if(a)for(r=0;r<e.colModel.length;r++)if((o=e.colModel[r]).name===t){if(o.odata.nosearch)return;if(o.odata.unformat&&!(t=v.jgrid.isFunction(o.odata.unformat)?o.odata.unformat(t,a,n):o.odata.unformat))return;o.searchrules&&(o.searchrules.integer||o.searchrules.number||o.searchrules.date)?o.searchrules&&o.searchrules.date&&(a=new Date(a).toISOString()):a="'"+a+"'";break}switch(n){case"in":case"cn":return"indexof("+t+",tolower("+a+")) gt -1";case"ni":case"nc":return"indexof("+t+",tolower("+a+")) eq -1";case"bw":return"startswith("+t+","+a+") eq true";case"bn":return"startswith("+t+","+a+") eq false";case"ew":return"endswith("+t+","+a+") eq true";case"en":return"endswith("+t+","+a+") eq false";case"nu":return t+" eq null";case"nn":return t+" ne null";default:return t+" "+n+" "+a}}}function r(e,t,a){var n,r={};return e.odata.iscollection?(r={$top:a.rows,$skip:(parseInt(a.page,10)-1)*e.rowNum},"jsonp"===t.datatype&&(r.$callback=t.callback),!t.version||t.version<4?(r.$inlinecount="allpages",r.$format="xml"===t.datatype?"atom":"application/json;odata=fullmetadata"):(r.$count=!0,r.$format="xml"===t.datatype?"atom":"application/json;odata.metadata=full"),a.sidx&&(r.$orderby=a.sidx+" "+a.sord),a._search&&(a.filters?0<(n=function e(t,a){var n,r,o="";if(t.groups&&t.groups.length){for(n=0;n<t.groups.length;n++)o+="("+e(t.groups[n],a)+")",n<t.groups.length-1&&(o+=" "+t.groupOp.toLowerCase()+" ");t.rules&&t.rules.length&&(o+=" "+t.groupOp.toLowerCase()+" ")}if(t.rules.length)for(n=0;n<t.rules.length;n++)(r=i(a,(r=t.rules[n]).field,r.data,r.op))&&(o+=r+" "+t.groupOp.toLowerCase()+" ");return o=o.trim().replace(/\s(and|or)$/,"").trim()}(v.parseJSON(a.filters),e)).length&&(r.$filter=n):r.$filter=i(e,a.searchField,a.searchString,a.searchOper))):!t.version||t.version<4?r.$format="xml"===t.datatype?"atom":"application/json;odata=fullmetadata":r.$format="xml"===t.datatype?"atom":"application/json;odata.metadata=full",r}function d(i,d){function e(e,t){return n=d,e=e,t=t,r=(a=i).colModel.filter(function(e){return e.name===a.odata.activeEntitySet})[0],t=a._index[t],t=a.odata.iscollection?v.jgrid.format("{0}({1})/{2}",a.url,t,a.odata.activeEntitySet):v.jgrid.format("{0}/{1}",a.url,a.odata.activeEntitySet),o={datatype:n.datatype,version:n.version,gencolumns:!1,expandable:n.expandable,odataurl:t,errorfunc:n.errorfunc,annotations:n.annotations,entitySet:a.odata.activeEntitySet},v("#"+e).html('<table id="'+e+'_t" class="scroll"></table>'),void v("#"+e+"_t").jqGrid({colModel:a.odata.subgridCols[a.odata.activeEntitySet],odata:v.extend({},a.odata,r.odata),loadonce:!0,beforeInitGrid:function(){v(this).jqGrid("odataInit",o)},loadError:function(e,t,a){e=v.jgrid.odataHelper.loadError(e,t,a),e=v("#errdialog").html()+e;v("#errdialog").html(e).dialog("open")}});var a,n,r,o}var t,a={datatype:d.datatype,jsonpCallback:d.callback};if(i.odata||(i.odata={iscollection:!0}),v.extend(i,{serializeGridData:function(e){return e=r(i,d,e),this.p.odata.postData=e},ajaxGridOptions:a,mtype:"GET",url:d.odataurl},a),i.colModel)for(t=0;t<i.colModel.length;t++)if(i.colModel[t].odata&&"subgrid"===i.colModel[t].odata.expand){i.subGrid=!0,i.subGridRowExpanded=e,i.odata.activeEntitySet=i.colModel[t].name,i.loadonce=!0;break}a={contentType:"application/"+("jsonp"===d.datatype?"json":d.datatype)+";charset=utf-8",datatype:"jsonp"===d.datatype?"json":d.datatype};i.inlineEditing=v.extend(!0,{beforeSaveRow:function(e,t){return"edit"===e.extraparam.oper?(e.url=d.odataurl,e.mtype=d.odataverbs.inlineEditingEdit,e.url+="("+t+")"):(e.url=d.odataurl,e.mtype=d.odataverbs.inlineEditingAdd),!0},serializeSaveData:function(e){return JSON.stringify(e)},ajaxSaveOptions:a},i.inlineEditing||{}),v.extend(i.formEditing,{onclickSubmit:function(e,t,a){return"add"===a?(e.url=d.odataurl,e.mtype=d.odataverbs.formEditingAdd):"edit"===a&&(e.url=d.odataurl+"("+t[i.id+"_id"]+")",e.mtype=d.odataverbs.formEditingEdit),t},ajaxEditOptions:a,serializeEditData:function(e){return JSON.stringify(e)}}),v.extend(i.formDeleting,{url:d.odataurl,mtype:"DELETE",serializeDelData:function(){return""},onclickSubmit:function(e,t){return e.url+="("+t+")",""},ajaxDelOptions:a});var n,a=(a=i.colModel.filter(function(e){return!!e.key})[0])?a.name:i.sortname||"id";"xml"===d.datatype?(d.annotations&&v.extend(!0,i,{loadBeforeSend:function(e){e.setRequestHeader("Prefer",'odata.include-annotations="*"')}}),n=">entry",v.extend(!0,i,{xmlReader:{root:function(e){(e=e.childNodes[0]).innerHTML=e.innerHTML.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>");var t=v(e).attr("m:context");return t&&(i.odata.baseUrl=t.substring(0,t.indexOf("/$metadata")),i.odata.entityType=t.substring(t.indexOf("#")+1).replace("/$entity","")),(t=v(e).attr("m:type"))&&(i.odata.entityType=t.replace("#","")),e},row:function(e){return e="entry"===e.localName?[e]:v(n,e)},cell:function(e){return v(">content>properties",e).get(0).childNodes},records:function(e){return v(">feed"+n,e).length},page:function(){var e=i.odata.postData.$skip+i.rowNum;return Math.ceil(e/i.rowNum)},total:function(e){var e=v(">feed"+n,e).length,t=i.odata.postData.$skip+i.rowNum;return Math.ceil(t/i.rowNum)+(0<e?1:0)},repeatitems:!0,userdata:"userdata",id:a}})):(v.extend(!0,i,{jsonReader:{root:function(e){var t=e["@odata.context"];return t&&(i.odata.baseUrl=t.substring(0,t.indexOf("/$metadata")),i.odata.entityType=t.substring(t.indexOf("#")+1).replace("/$entity","")),(t=e["@odata.type"])&&(i.odata.entityType=t.replace("#","")),e.value||[e]},repeatitems:!0,id:a}}),d.annotations?v.extend(!0,i,{loadBeforeSend:function(e){e.setRequestHeader("Prefer",'odata.include-annotations="*"')},jsonReader:{records:function(e){return e[d.annotationName].records},page:function(e){return e[d.annotationName].page},total:function(e){return e[d.annotationName].total},userdata:function(e){return e[d.annotationName].userdata}}}):v.extend(!0,i,{jsonReader:{records:function(e){return e["odata.count"]||e["@odata.count"]},page:function(e){var t;return e["odata.nextLink"]?t=parseInt(e["odata.nextLink"].split("skip=")[1],10):(t=i.odata.postData.$skip+i.rowNum,(e=e["odata.count"]||e["@odata.count"])<t&&(t=e)),Math.ceil(t/i.rowNum)},total:function(e){e=e["odata.count"]||e["@odata.count"];return Math.ceil(e/i.rowNum)},userdata:"userdata"}}))}return this.each(function(){var e,t,a=this,n=v(this),r=this.p;a.grid&&r&&("jsonp"===(e=v.extend(!0,{gencolumns:!1,odataurl:r.url,datatype:"json",entitySet:null,annotations:!1,annotationName:"@jqgrid.GridModelAnnotate",odataverbs:{inlineEditingAdd:"POST",inlineEditingEdit:"PATCH",formEditingAdd:"POST",formEditingEdit:"PUT"}},o||{})).datatype&&(e.callback="jsonpCallback"),e.entitySet?(e.gencolumns&&((t=v.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,async:!1,entitySet:null,metadatatype:o.datatype||"xml",metadataurl:(o.odataurl||r.url)+"/$metadata"},o||{})).async&&(t.successfunc=function(){a.grid.hDiv&&(a.grid.hDiv.loading=!1),n.jqGrid("setGridParam",{datatype:e.datatype}).trigger("reloadGrid")},a.grid.hDiv)&&(a.grid.hDiv.loading=!0),n.jqGrid("odataGenColModel",t)),d(r,e)):v.jgrid.isFunction(e.errorfunc)&&e.errorfunc({},"entitySet cannot be empty",0))})},odataGenColModel:function(e){var i,d,t=this[0],l=t.p,s=v(t),c=v.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,entitySet:null,metadataurl:l.url+"/$metadata",metadatatype:"xml",expandable:"link",async:!1},e||{});if("jsonp"===c.metadatatype&&(c.callback="jsonpCallback"),c.entitySet)return v.ajax({url:c.metadataurl,type:"GET",dataType:c.metadatatype,jsonpCallback:c.callback,async:c.async,cache:!1}).done(function(e,t,a){var n=0,r=0,o=0;if("json"!==c.metadatatype&&"jsonp"!==c.metadatatype||(e=v.jgrid.odataHelper.resolveJsonReferences(e)),i=!(i=s.triggerHandler("jqGridODataParseMetadata",e))&&v.jgrid.isFunction(c.parsemetadatafunc)?c.parsemetadatafunc(e,t,a):i)d=i;else if((i=v.jgrid.odataHelper.parseMetadata(e,c.metadatatype))&&!(d=!(d=s.triggerHandler("jqGridODataParseColumns",[c,i]))&&v.jgrid.isFunction(c.parsecolfunc)?c.parsecolfunc(c,i):d))for(n in d={},i)i.hasOwnProperty(n)&&n&&(d[n]=s.jqGrid("parseColumns",i[n],c.expandable));if(d){for(o in d)if(d.hasOwnProperty(o)&&o)for(n=0;n<l.colModel.length;n++)for(r=0;r<d[o].length;r++)if(d[o][r].name===l.colModel[n].name){v.extend(!0,d[o][r],l.colModel[n]);break}l.colModel=d[c.entitySet],l.colModel||v.jgrid.isFunction(c.errorfunc)&&c.errorfunc({data:e,status:t,xhr:a},"EntitySet "+c.entitySet+" is not found"),l.odata||(l.odata={iscollection:!0}),l.odata.subgridCols=d,v.jgrid.isFunction(c.successfunc)&&c.successfunc()}else v.jgrid.isFunction(c.errorfunc)&&c.errorfunc({data:e,status:t,xhr:a},"parse $metadata error")}).fail(function(e,t,a){var n;v.jgrid.isFunction(c.errorfunc)&&(n=v.jgrid.odataHelper.loadError(e,t,a),c.errorfunc({xhr:e,error:t,code:a},n))}),d;v.jgrid.isFunction(c.errorfunc)&&c.errorfunc({},"entitySet cannot be empty",0)}})});
//# sourceMappingURL=grid.odata.js.map